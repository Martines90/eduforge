rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isTeacher() {
      return isAuthenticated() && getUserData().role == 'teacher';
    }

    function isEmailVerified() {
      return isAuthenticated() && getUserData().emailVerified == true;
    }

    // Users collection
    match /users/{userId} {
      // Anyone can read user profiles (for displaying creator names, etc.)
      allow read: if true;

      // Users can only create their own profile during registration
      allow create: if isAuthenticated() && request.auth.uid == userId;

      // Users can only update their own profile
      allow update: if isOwner(userId);

      // Users cannot delete their profile (must be done via admin)
      allow delete: if false;
    }

    // Subject mappings collection (curriculum structure)
    match /subjectMappings/{mappingId} {
      // Anyone can read subject mappings (public curriculum data)
      allow read: if true;

      // Only admins can create/update/delete (via backend only)
      allow write: if false;
    }

    // Tasks collection
    match /tasks/{taskId} {
      // Published tasks can be read by anyone
      // Unpublished tasks can only be read by their creator
      allow read: if resource.data.isPublished == true
                  || isOwner(resource.data.createdBy);

      // Only verified teachers can create tasks
      allow create: if isTeacher()
                    && isEmailVerified()
                    && request.resource.data.createdBy == request.auth.uid
                    && request.resource.data.creatorName == getUserData().name;

      // Only the creator can update their own tasks
      allow update: if isOwner(resource.data.createdBy)
                    && request.resource.data.createdBy == resource.data.createdBy; // Can't change ownership

      // Only the creator can delete their own tasks
      allow delete: if isOwner(resource.data.createdBy);

      // Task ratings subcollection
      match /ratings/{ratingId} {
        // Anyone can read ratings for published tasks
        allow read: if get(/databases/$(database)/documents/tasks/$(taskId)).data.isPublished == true;

        // Authenticated users can create/update their own rating
        // The ratingId should be the user's UID
        allow create: if isAuthenticated()
                      && ratingId == request.auth.uid
                      && request.resource.data.userId == request.auth.uid
                      && request.resource.data.rating >= 0
                      && request.resource.data.rating <= 5;

        allow update: if isAuthenticated()
                      && ratingId == request.auth.uid
                      && request.resource.data.userId == request.auth.uid
                      && request.resource.data.rating >= 0
                      && request.resource.data.rating <= 5;

        // Users can delete their own ratings
        allow delete: if isAuthenticated() && ratingId == request.auth.uid;
      }
    }

    // Verification codes collection (for email verification)
    match /verificationCodes/{email} {
      // No direct read access (verified via backend)
      allow read: if false;

      // Backend creates verification codes
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    // Task completions/progress (future feature)
    match /userProgress/{userId} {
      // Users can read their own progress
      allow read: if isOwner(userId);

      // Users can update their own progress
      allow write: if isOwner(userId);

      match /taskCompletions/{taskId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
    }

    // Analytics/aggregations collection (if needed in future)
    match /analytics/{document=**} {
      // Read-only, updated by backend/cloud functions
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // Country-specific collections (tests/worksheets)
    match /countries/{country}/tests/{testId} {
      // Teachers can read their own tests
      allow read: if isTeacher() && isOwner(resource.data.createdBy);

      // Only verified teachers can create tests
      allow create: if isTeacher()
                    && isEmailVerified()
                    && request.resource.data.createdBy == request.auth.uid
                    && request.resource.data.creatorName == getUserData().name;

      // Only the creator can update their own tests
      allow update: if isTeacher()
                    && isOwner(resource.data.createdBy)
                    && request.resource.data.createdBy == resource.data.createdBy;

      // Only the creator can delete their own tests
      allow delete: if isTeacher() && isOwner(resource.data.createdBy);

      // Test tasks subcollection
      match /test_tasks/{testTaskId} {
        // Teachers can read tasks in their own tests
        allow read: if isTeacher() && isOwner(get(/databases/$(database)/documents/countries/$(country)/tests/$(testId)).data.createdBy);

        // Teachers can manage tasks in their own tests
        allow write: if isTeacher() && isOwner(get(/databases/$(database)/documents/countries/$(country)/tests/$(testId)).data.createdBy);
      }
    }

    // Published tests collection (public access)
    match /countries/{country}/published_tests/{publicId} {
      // Anyone can read published tests (no authentication required)
      allow read: if true;

      // Only backend can write published tests
      allow write: if false;
    }

    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

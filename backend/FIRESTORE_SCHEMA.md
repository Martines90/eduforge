# Firestore Database Schema for EduForge

## Overview

This document describes the Firestore collections and document structure for storing hierarchical curriculum mappings and educational tasks.

## Collections Structure

### 1. `subjectMappings` Collection

Stores the hierarchical curriculum structure. Each document represents a node in the tree.

**Document ID**: Auto-generated by Firestore or use `{subject}_{grade}_{key}` for predictable IDs

**Document Structure**:
```typescript
interface SubjectMappingDocument {
  // Identity
  key: string;                    // "halmazok", "halmaz_fogalma", etc.
  name: string;                   // "Halmazok", "Halmaz fogalma és megadása"
  shortDescription?: string;      // Optional description

  // Hierarchy
  level: number;                  // 0=subject, 1=grade, 2+=categories
  parentId: string | null;        // Reference to parent document ID
  path: string;                   // "mathematics/grade_9_10/halmazok/halmaz_fogalma"

  // Classification
  subject: string;                // "mathematics", "physics", etc.
  gradeLevel: string;             // "grade_9_10", "grade_11_12"

  // Metadata
  orderIndex: number;             // For maintaining order within same parent
  isLeaf: boolean;                // TRUE if this can have tasks assigned

  // Stats (denormalized for performance)
  taskCount: number;              // Number of tasks assigned to this node

  // Timestamps
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

**Example Document** (`subjectMappings/math_9_10_halmazok`):
```json
{
  "key": "halmazok",
  "name": "Halmazok",
  "shortDescription": "Halmazelméleti alapfogalmak, halmazműveletek",
  "level": 2,
  "parentId": "math_9_10_root",
  "path": "mathematics/grade_9_10/halmazok",
  "subject": "mathematics",
  "gradeLevel": "grade_9_10",
  "orderIndex": 1,
  "isLeaf": false,
  "taskCount": 0,
  "createdAt": "2024-11-27T10:00:00Z",
  "updatedAt": "2024-11-27T10:00:00Z"
}
```

**Indexes** (Composite):
- `subject` + `gradeLevel` + `level`
- `parentId` + `orderIndex`
- `path` (for breadcrumb queries)
- `isLeaf` + `subject` + `gradeLevel`

---

### 2. `tasks` Collection

Stores individual educational tasks.

**Document ID**: Auto-generated by Firestore

**Document Structure**:
```typescript
interface TaskDocument {
  // Basic Info
  title: string;
  description?: string;

  // Content (stored as structured JSON)
  content: {
    type: string;                 // "multiple_choice", "open_ended", "problem_solving"
    questions: QuestionBlock[];
    solutions?: SolutionBlock[];
    hints?: string[];
  };

  // Curriculum Mapping
  subjectMappingId: string;       // Reference to subjectMappings document
  subjectMappingPath: string;     // Denormalized for faster queries
  subject: string;                // Denormalized: "mathematics"
  gradeLevel: string;             // Denormalized: "grade_9_10"

  // Metadata
  educationalModel: string;       // "secular", "traditional", etc.
  difficultyLevel?: string;       // "easy", "medium", "hard"
  estimatedDurationMinutes?: number;
  tags?: string[];                // Additional searchable tags

  // Engagement Metrics
  ratingAverage: number;          // 0.00 to 5.00
  ratingCount: number;            // Total number of ratings
  viewCount: number;
  completionCount: number;

  // Ownership & Status
  createdBy: string;              // UID of teacher who created it
  creatorName: string;            // Denormalized for display
  isPublished: boolean;
  publishedAt?: Timestamp;

  // Timestamps
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

**Example Document**:
```json
{
  "title": "Véges halmazok felsorolása - Alapfeladatok",
  "description": "Gyakorlófeladatok véges halmazok megadásához felsorolással",
  "content": {
    "type": "multiple_choice",
    "questions": [
      {
        "text": "Melyik halmaz elemei...",
        "options": ["A", "B", "C", "D"],
        "correctAnswer": 2
      }
    ]
  },
  "subjectMappingId": "math_9_10_halmazok_megadas_felsorolassal",
  "subjectMappingPath": "mathematics/grade_9_10/halmazok/halmaz_fogalma/halmaz_megadas_felsorolassal",
  "subject": "mathematics",
  "gradeLevel": "grade_9_10",
  "educationalModel": "secular",
  "difficultyLevel": "easy",
  "estimatedDurationMinutes": 15,
  "tags": ["halmazok", "alapok"],
  "ratingAverage": 4.5,
  "ratingCount": 23,
  "viewCount": 1234,
  "completionCount": 567,
  "createdBy": "user_uid_123",
  "creatorName": "Nagy Péter",
  "isPublished": true,
  "publishedAt": "2024-11-15T14:30:00Z",
  "createdAt": "2024-11-10T10:00:00Z",
  "updatedAt": "2024-11-15T14:30:00Z"
}
```

**Indexes** (Composite):
- `isPublished` + `subject` + `gradeLevel` + `ratingAverage` (DESC)
- `isPublished` + `subject` + `gradeLevel` + `viewCount` (DESC)
- `createdBy` + `createdAt` (DESC)
- `subjectMappingId` + `isPublished`

---

### 3. `taskRatings` Subcollection

Nested under each task document: `tasks/{taskId}/ratings/{userId}`

**Document Structure**:
```typescript
interface TaskRatingDocument {
  userId: string;
  rating: number;                 // 0-5 (integers only)
  reviewText?: string;
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

**Example**: `tasks/task123/ratings/user456`
```json
{
  "userId": "user456",
  "rating": 5,
  "reviewText": "Nagyon hasznos feladat!",
  "createdAt": "2024-11-20T16:45:00Z",
  "updatedAt": "2024-11-20T16:45:00Z"
}
```

---

### 4. `taskViews` Collection (Optional for Analytics)

Tracks individual task views for analytics.

**Document ID**: Auto-generated

**Document Structure**:
```typescript
interface TaskViewDocument {
  taskId: string;
  userId: string | null;          // NULL for anonymous users
  viewedAt: Timestamp;
  userAgent?: string;
  sessionId?: string;
}
```

**Indexes**:
- `taskId` + `viewedAt` (DESC)
- `userId` + `viewedAt` (DESC)

---

## Firestore Queries

### Get Subject Mapping Tree for a Grade

```typescript
// Get all nodes for mathematics grade 9-10
const db = getFirestore();
const snapshot = await db.collection('subjectMappings')
  .where('subject', '==', 'mathematics')
  .where('gradeLevel', '==', 'grade_9_10')
  .orderBy('level')
  .orderBy('orderIndex')
  .get();

const nodes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
```

### Get All Child Nodes

```typescript
// Get children of a specific parent
const snapshot = await db.collection('subjectMappings')
  .where('parentId', '==', 'math_9_10_halmazok')
  .orderBy('orderIndex')
  .get();
```

### Get Tasks for a Category

```typescript
// Get published tasks for a specific category
const snapshot = await db.collection('tasks')
  .where('subjectMappingId', '==', 'math_9_10_halmazok_megadas')
  .where('isPublished', '==', true)
  .orderBy('ratingAverage', 'desc')
  .limit(20)
  .get();

const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
```

### Get Top Rated Tasks

```typescript
// Get top rated tasks for mathematics grade 9-10
const snapshot = await db.collection('tasks')
  .where('subject', '==', 'mathematics')
  .where('gradeLevel', '==', 'grade_9_10')
  .where('isPublished', '==', true)
  .orderBy('ratingAverage', 'desc')
  .orderBy('ratingCount', 'desc')
  .limit(50)
  .get();
```

### Get Teacher's Tasks

```typescript
// Get all tasks created by a specific teacher
const snapshot = await db.collection('tasks')
  .where('createdBy', '==', teacherUid)
  .orderBy('createdAt', 'desc')
  .get();
```

### Submit Rating

```typescript
// Add or update rating for a task
const taskRef = db.collection('tasks').doc(taskId);
const ratingRef = taskRef.collection('ratings').doc(userId);

await db.runTransaction(async (transaction) => {
  const taskDoc = await transaction.get(taskRef);
  const existingRatingDoc = await transaction.get(ratingRef);

  const taskData = taskDoc.data();
  let newRatingAverage = taskData.ratingAverage;
  let newRatingCount = taskData.ratingCount;

  if (existingRatingDoc.exists) {
    // Update existing rating
    const oldRating = existingRatingDoc.data().rating;
    const totalRating = taskData.ratingAverage * taskData.ratingCount;
    newRatingAverage = (totalRating - oldRating + newRating) / taskData.ratingCount;
  } else {
    // New rating
    const totalRating = taskData.ratingAverage * taskData.ratingCount + newRating;
    newRatingCount = taskData.ratingCount + 1;
    newRatingAverage = totalRating / newRatingCount;
  }

  // Update rating document
  transaction.set(ratingRef, {
    userId,
    rating: newRating,
    reviewText,
    createdAt: existingRatingDoc.exists ? existingRatingDoc.data().createdAt : new Date(),
    updatedAt: new Date(),
  });

  // Update task aggregates
  transaction.update(taskRef, {
    ratingAverage: newRatingAverage,
    ratingCount: newRatingCount,
    updatedAt: new Date(),
  });
});
```

### Increment View Count

```typescript
// Increment view count atomically
const taskRef = db.collection('tasks').doc(taskId);
await taskRef.update({
  viewCount: admin.firestore.FieldValue.increment(1),
});

// Optional: Log detailed view
await db.collection('taskViews').add({
  taskId,
  userId: userId || null,
  viewedAt: new Date(),
});
```

---

## Migration Strategy

### Step 1: Parse JSON and Import to Firestore

Create a migration script that:
1. Reads JSON files from `src/data/subject_mapping/`
2. Recursively traverses the hierarchy
3. Creates documents in `subjectMappings` collection

### Step 2: Create Initial Test Tasks

Once subject mappings are imported, create a few test tasks for each leaf node.

---

## Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isTeacher() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Subject Mappings - Read-only for all users
    match /subjectMappings/{mappingId} {
      allow read: if true; // Public read
      allow write: if false; // Only via backend/admin
    }

    // Tasks
    match /tasks/{taskId} {
      // Anyone can read published tasks
      allow read: if resource.data.isPublished == true ||
                     isOwner(resource.data.createdBy);

      // Only teachers can create tasks
      allow create: if isTeacher();

      // Only owner can update/delete their own tasks
      allow update, delete: if isOwner(resource.data.createdBy);

      // Ratings subcollection
      match /ratings/{userId} {
        // Users can read all ratings
        allow read: if true;

        // Users can only write their own rating
        allow create, update: if isAuthenticated() && userId == request.auth.uid;
        allow delete: if isOwner(userId);
      }
    }

    // Task Views
    match /taskViews/{viewId} {
      allow read: if false; // Only via backend
      allow create: if true; // Allow logging views
    }
  }
}
```

---

## Backend API Endpoints

### Subject Mappings

- `GET /api/subjects/:subject/grades/:grade/tree`
  - Returns hierarchical tree structure
  - Response: Array of SubjectMappingDocument with nested children

- `GET /api/subjects/:subject/grades/:grade/leaf-nodes`
  - Returns only leaf nodes (where tasks can be assigned)
  - Used in task creation form

### Tasks

- `GET /api/tasks`
  - Query params: `subject`, `gradeLevel`, `mappingId`, `search`, `sort`, `limit`, `offset`
  - Returns paginated task list
  - Response: `{ tasks: TaskDocument[], total: number, page: number }`

- `GET /api/tasks/:id`
  - Returns single task with full details
  - Increments view count

- `POST /api/tasks` (Teachers only)
  - Creates new task
  - Body: TaskDocument (without auto-generated fields)
  - Validates that `subjectMappingId` points to a leaf node

- `PUT /api/tasks/:id` (Owner only)
  - Updates existing task
  - Cannot change `createdBy`

- `DELETE /api/tasks/:id` (Owner only)
  - Soft delete (set `isPublished = false`) or hard delete

- `GET /api/tasks/my` (Teachers only)
  - Returns tasks created by authenticated teacher
  - Query params: `status` (all/published/draft)

### Ratings

- `POST /api/tasks/:id/rate` (Authenticated users)
  - Submits rating for a task
  - Body: `{ rating: number (0-5), reviewText?: string }`
  - Updates aggregate rating in task document

- `GET /api/tasks/:id/ratings`
  - Returns ratings for a task
  - Paginated

---

## Advantages of This Firestore Design

✅ **NoSQL Flexibility**: Easy to add new fields without migrations
✅ **Scalable**: Firestore handles millions of documents
✅ **Real-time**: Can use Firestore listeners for live updates
✅ **Denormalization**: Fast queries without complex joins
✅ **Security**: Fine-grained security rules at document level
✅ **Offline Support**: Firestore SDK supports offline mode in frontend
✅ **Subcollections**: Clean organization for ratings under tasks

---

## Next Steps

1. ✅ Create Firestore schema documentation (DONE)
2. Create TypeScript types for all document structures
3. Create service layer for CRUD operations
4. Create migration script to import JSON data
5. Implement API routes with Express
6. Add Firestore security rules
7. Update frontend to call new API endpoints
